# Документация проекта "Финансовый портал"

## Обзор проекта

**Финансовый портал** — это одностраничное веб-приложение (SPA) для управления проектами и расчета их финансовых показателей. Приложение предназначено для внутреннего использования в организации и позволяет вести учет проектов, их этапов, затрат и формировать проектные калькуляции.

## Структура проекта

```
cursor_finportal_v2/
├── index.html          # Главная HTML-страница
├── css/
│   └── style.css       # Стили приложения
└── js/
    ├── data.js         # Исходные данные и справочники
    └── app.js          # Основная логика приложения
```

## Технологический стек

- **HTML5** — разметка страниц
- **CSS3** — стилизация интерфейса
- **Vanilla JavaScript** — клиентская логика
- **Flexbox** — верстка макета
- **CSS Grid** — для некоторых компонентов

## Архитектура приложения

### Основные принципы
- **SPA (Single Page Application)** — все страницы рендерятся динамически
- **Компонентный подход** — каждый экран представлен отдельной функцией рендеринга
- **Централизованное управление состоянием** — через глобальные переменные
- **Событийно-ориентированная архитектура** — взаимодействие через обработчики событий

### Управление состоянием
```javascript
let currentUser = null;           // Текущий пользователь
let isPageDirty = false;          // Флаг изменений на странице
let navigationTarget = null;      // Цель навигации при подтверждении
let currentProjectData = null;    // Данные текущего проекта
```

## Функциональные модули

### 1. Аутентификация (`renderLogin`)
- **Функция**: `renderLogin()`
- **Назначение**: Страница входа в систему
- **Особенности**: 
  - Простая форма с логином/паролем
  - Валидация учетных данных из массива `users`
  - Обработка ошибок входа

### 2. Список проектов (`renderProjects`)
- **Функция**: `renderProjects()`
- **Назначение**: Отображение и управление списком проектов
- **Функциональность**:
  - Таблица проектов с поиском
  - Создание новых проектов
  - Переход к расчету затрат выбранного проекта
- **Данные**: Использует массив `table_projects`

### 3. Расчет затрат (`renderCostCalculation`)
- **Функция**: `renderCostCalculation(project)`
- **Назначение**: Основной модуль для создания/редактирования проектов
- **Компоненты**:
  - **Основная информация**: ID проекта, номер сделки CRM, команда
  - **Показатели проекта**: тип контрактования, рентабельность, расчетные суммы
  - **Этапы проекта**: таблица с датами, периодами, плановой выручкой
  - **Затраты по этапам**: внешние закупки, ФОТ, внутренние продукты

### 4. Проектная калькуляция (`renderProjectCalculation`)
- **Функция**: `renderProjectCalculation()`
- **Назначение**: Формирование итоговой сводки проекта
- **Функциональность**:
  - Агрегация данных по годам
  - Расчет выручки и затрат
  - Генерация сводных таблиц
  - Цветовое кодирование по типам данных

## Структура данных

### Пользователи (`users`)
```javascript
{
    user_id: number,
    user_name: string,
    user_password: string,
    user_role: string
}
```

### Проекты (`table_projects`)
```javascript
{
    project_id: number,
    project_name: string,
    project_kam: string,
    project_client: string,
    project_crm_integration_id: string,
    project_status: string
}
```

### Этапы проектов (`project_stage`)
```javascript
{
    project_id: number,
    stage_number: number,
    stage_name: string,
    stage_date_start: string,
    stage_date_end: string,
    stage_period_type: string,
    stage_period_count: number,
    stage_planned_revenue: number
}
```

### Затраты проектов (`project_cost`)
```javascript
{
    stage_number: number,
    stage_name: string,
    cost_number: number,
    cost_name: string,
    cost_date_start: string,
    cost_date_end: string,
    cost_type: string,
    cost_period: string,
    cost_deprecation: number,
    cost_cost: number,
    cost_cost_for_client: number,
    cost_departamenet: string,
    cost_specialist_grade: string,
    cost_specialist_hour_cost: number,
    cost_specialist_hour_count: number,
    cost_service_type: string
}
```

## Справочники и константы

### Роли пользователей (`roles`)
- `admin` — Администратор системы
- `key_account_manager` — КАМ
- `director` — КАМ+
- `calc_manager` — ЦОСП
- `cost_effiency_manager` — СКЭ
- `contract_manager` — ДЦ
- `calc_center` — РЦ
- `project_manager` — Руководитель проекта

### Типы затрат
- **Внешние закупки**: Оборудование, Расходники, Программное обеспечение
- **ФОТ**: По отделам (Эксплуатация, ИБ, Сетевой отдел) и грейдам
- **Внутренние продукты**: IaaS, Colocation, Unit-Colo

### Периодичность затрат
- Разовое
- Ежемесячно
- Ежеквартально
- Ежегодно

## Ключевые функции

### Навигация и роутинг
- `navigate(page, data)` — основная функция навигации
- `guardedNavigate(page, data)` — навигация с проверкой несохраненных изменений
- `clearApp()` — очистка контейнера приложения

### Рендеринг компонентов
- `renderMainLayout()` — основной макет с навигацией и хедером
- `renderStageRow()` — строка этапа проекта
- `renderStageCosts()` — блок затрат для этапа
- `renderExternalCostRow()` — строка внешних затрат
- `renderFotCostRow()` — строка ФОТ
- `renderInternalCostRow()` — строка внутренних продуктов

### Расчеты и обработка данных
- `updateAllCalculations()` — пересчет всех финансовых показателей
- `captureCostData()` — сбор данных со страницы расчета затрат
- `generateSummaryHTML()` — генерация HTML для сводки
- `generateSummaryTable()` — создание сводных таблиц

### Модальные окна
- `showModal(modalId)` — отображение модального окна
- `closeModal()` — закрытие модальных окон
- `renderModals()` — рендеринг всех модальных окон

## Пользовательский интерфейс

### Дизайн-система
- **Цветовая схема**: Синий (#007bff) как основной цвет
- **Шрифт**: Roboto (Google Fonts)
- **Компоненты**: Карточки, таблицы, формы, кнопки
- **Адаптивность**: Фиксированная ширина навигации (200px)

### Основные экраны
1. **Страница входа**: Центрированная форма аутентификации
2. **Главная страница**: Боковая навигация + основной контент
3. **Список проектов**: Таблица с поиском и фильтрацией
4. **Расчет затрат**: Многосекционная форма с динамическими элементами
5. **Проектная калькуляция**: Сводные таблицы с цветовым кодированием

### Интерактивные элементы
- **Модальные окна**: Выбор команды, импорт из CRM, подтверждение навигации
- **Динамические таблицы**: Добавление/удаление строк этапов и затрат
- **Автоматические расчеты**: Обновление сумм при изменении данных
- **Поиск**: Фильтрация проектов по различным критериям

## Бизнес-логика

### Расчеты рентабельности
- **Формула**: `costForClient = cost * (1 + profitability)`
- **Применение**: Ко всем типам затрат
- **Обновление**: В реальном времени при изменении рентабельности

### Расчет ФОТ
- **Основа**: Справочник `grades_list` с почасовыми ставками
- **Формула**: `cost = hours * rate`
- **Автоматизация**: Ставка подставляется автоматически по отделу и грейду

### Периодические затраты
- **Распределение**: По месяцам/кварталам/годам в зависимости от типа
- **Расчет периодов**: Автоматический по датам начала и окончания
- **Агрегация**: Суммирование по годам для сводки

## Особенности реализации

### Управление состоянием страницы
- **Флаг `isPageDirty`**: Отслеживает несохраненные изменения
- **Подтверждение навигации**: Модальное окно при попытке ухода с измененной страницы
- **Сохранение данных**: В оперативной памяти перед навигацией

### Обработка событий
- **Делегирование**: Для динамически создаваемых элементов
- **Множественные обработчики**: Для сложных интерактивных компонентов
- **Предотвращение всплытия**: Для модальных окон

### Производительность
- **Минимальные перерисовки**: Обновление только измененных элементов
- **Эффективные селекторы**: Использование `querySelector` и `closest`
- **Оптимизированные расчеты**: Пересчет только при необходимости

## Возможности для развития

### Функциональные улучшения
- Сохранение данных на сервере
- Экспорт отчетов в PDF/Excel
- Интеграция с внешними CRM-системами
- Система уведомлений и согласований
- История изменений проектов

### Технические улучшения
- Переход на современный фреймворк (React/Vue/Angular)
- Внедрение TypeScript для типизации
- Добавление unit-тестов
- Оптимизация производительности
- Улучшение UX/UI дизайна

### Архитектурные улучшения
- Разделение на модули
- Внедрение паттерна MVC/MVVM
- Централизованное управление состоянием
- API-слой для работы с данными
- Система плагинов для расширения функциональности

## Заключение

Финансовый портал представляет собой функциональное веб-приложение для управления проектами и их финансовыми показателями. Несмотря на использование vanilla JavaScript, приложение демонстрирует хорошую архитектуру и структуру кода. Основные функции реализованы полностью и готовы к использованию, а модульная структура позволяет легко расширять функциональность в будущем. 